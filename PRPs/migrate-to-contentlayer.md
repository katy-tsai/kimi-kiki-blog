# PRP: Migrate from Manual Markdown Parser to Contentlayer2

**Created**: 2025-10-18
**Feature Spec**: spec/contentlayer_spec.md
**Confidence Score**: 8/10

---

## Goal

將目前基於 gray-matter + remark 的手動 Markdown 解析器全面遷移至 Contentlayer2，以獲得型別安全的內容管理、更好的開發體驗，以及與 Next.js 15 + React 19 的完整兼容性。

**End State**:
- 所有文章內容由 Contentlayer2 自動生成型別定義和資料
- 保持現有功能：PlantUML 圖表渲染、圖片路徑處理、TOC 生成
- 支援 GFM (GitHub Flavored Markdown)
- 開發時自動重新生成內容（hot-reload）
- Build 時靜態生成所有文章

---

## Why

### Business Value
- **型別安全**: Contentlayer 自動生成 TypeScript 型別，減少執行期錯誤
- **開發效率**: 自動化內容處理流程，減少手動程式碼維護
- **更好的 DX**: 內容變更即時反映，無需手動重啟伺服器
- **可擴展性**: 標準化的內容處理方式，易於添加新功能

### Integration with Existing Features
- 整合現有的 PlantUML 渲染功能
- 保持與 Next.js App Router 的兼容性
- 相容現有的文章結構和 Frontmatter 格式

### Problems This Solves
1. 手動維護 Markdown 解析邏輯的複雜性
2. 缺乏型別安全導致的潛在錯誤
3. 開發時需要手動重啟才能看到內容變更
4. 與 Next.js 15 + React 19 的兼容性問題

---

## What

### User-Visible Behavior
- 文章顯示和現有行為完全一致
- PlantUML 圖表正常渲染
- 圖片正常顯示（路徑自動轉換）
- TOC（目錄）正常工作
- 支援 GFM 語法（表格、刪除線、任務列表等）

### Technical Requirements
1. 安裝 Contentlayer2 相關套件
2. 建立 contentlayer.config.ts 配置檔
3. 配置 remark/rehype 插件
4. 更新 Next.js 配置
5. 重構 lib/posts.ts 使用 Contentlayer API
6. 更新所有頁面組件
7. 移除舊的 Markdown 處理程式碼

### Success Criteria
- [x] 所有文章正常顯示，無樣式或功能損失
- [x] PlantUML 圖表正常渲染
- [x] 圖片路徑自動轉換（/public/images/ → /images/）
- [x] TOC 正常運作（標題有 ID）
- [x] 型別檢查通過（TypeScript 無錯誤）
- [x] Build 成功（npm run build 無錯誤）
- [x] 開發模式下內容變更自動重新載入

---

## All Needed Context

### Documentation & References

```yaml
# MUST READ - Include these in your context window

- url: https://www.npmjs.com/package/contentlayer2
  why: Official Contentlayer2 package documentation and installation guide
  critical: This is a FORK of Contentlayer that works with Next.js 15 + React 19

- url: https://contentlayer.dev/docs/getting-started-cddd76b7
  why: Getting started guide (configuration applies to contentlayer2 with updated imports)

- url: https://contentlayer.dev/docs/reference/source-files/make-source-a5ba4922
  why: makeSource API reference for configuring remark/rehype plugins
  section: mdx.remarkPlugins and mdx.rehypePlugins configuration

- url: https://github.com/remarkjs/remark-gfm
  why: GitHub Flavored Markdown plugin for tables, strikethrough, task lists
  critical: Required for GFM support as specified in feature spec

- url: https://contentlayer.dev/docs/environments/nextjs-dcf8e39e
  why: Next.js integration guide (withContentlayer configuration)

- file: lib/remark-plantuml.ts
  why: Custom PlantUML plugin that MUST be preserved and integrated
  critical: This plugin transforms plantuml code blocks to SVG images

- file: lib/markdown.ts
  why: Current implementation showing image path transformation and heading ID logic
  critical: Need to replicate addHeadingIds() and transformImagePaths() functionality

- file: lib/posts.ts
  why: Current posts API that will be replaced with Contentlayer's allPosts
  pattern: Functions to preserve: getAllPosts, getPostBySlug, getSortedPosts, getAllTags, getRecommendedPosts

- file: types/post.ts
  why: Current type definitions that will be replaced by Contentlayer-generated types
  pattern: Frontmatter structure to mirror in contentlayer.config.ts

- file: app/posts/[slug]/page.tsx
  why: Example of how posts are currently consumed
  pattern: Usage of getPostBySlug and getAllPosts for generateStaticParams
```

### Current Codebase Tree

```bash
kimi-kiki-blog/
├── app/
│   ├── layout.tsx
│   ├── page.tsx                    # Uses getAllTags, getSortedPosts
│   ├── posts/
│   │   └── [slug]/page.tsx         # Uses getPostBySlug, getAllPosts
│   ├── tags/
│   │   ├── page.tsx
│   │   └── [tag]/page.tsx
│   ├── about/page.tsx
│   └── contact/page.tsx
├── components/
│   ├── article/
│   │   ├── ArticleCard.tsx
│   │   ├── ArticleList.tsx
│   │   └── TOC.tsx                 # Needs heading IDs
│   ├── layout/
│   ├── ui/
│   └── ...
├── content/
│   └── posts/
│       ├── hello-world.md
│       ├── claude-make-blog.md
│       └── ...                     # All markdown files
├── lib/
│   ├── markdown.ts                 # TO BE REMOVED/REPLACED
│   ├── posts.ts                    # TO BE HEAVILY MODIFIED
│   └── remark-plantuml.ts          # TO BE INTEGRATED
├── types/
│   └── post.ts                     # TO BE REPLACED with generated types
├── public/
│   └── images/                     # Image assets
├── package.json
├── next.config.js                  # TO BE MODIFIED
└── tsconfig.json                   # TO BE MODIFIED
```

### Desired Codebase Tree (New Files)

```bash
kimi-kiki-blog/
├── contentlayer.config.ts          # NEW: Contentlayer configuration
├── .contentlayer/                  # NEW: Auto-generated by Contentlayer (gitignore)
│   └── generated/
│       ├── index.d.ts
│       ├── Post/
│       └── ...
├── lib/
│   ├── rehype-image-path.ts        # NEW: Rehype plugin for image path transformation
│   ├── rehype-heading-ids.ts       # NEW: Rehype plugin for heading IDs
│   ├── remark-plantuml.ts          # PRESERVED: Existing PlantUML plugin
│   └── posts.ts                    # MODIFIED: Wrapper around Contentlayer API
└── (rest unchanged)
```

### Known Gotchas & Library Quirks

```typescript
// CRITICAL: Contentlayer2 fork compatibility
// Original contentlayer only supports Next.js ^12 || ^13
// MUST use contentlayer2 (fork) for Next.js 15 + React 19 support
// Install: npm install contentlayer2 next-contentlayer2

// CRITICAL: TypeScript 5+ required
// contentlayer2@0.5.8 requires TypeScript 5+ due to ts-pattern dependency
// Current project uses: "typescript": "^5.9.3" ✓ Compatible

// GOTCHA: Plugin order matters in makeSource
// remarkPlugins run BEFORE rehypePlugins
// PlantUML transformation must happen in remark phase (before HTML conversion)
// Heading IDs and image paths must happen in rehype phase (after HTML generation)

// GOTCHA: Next.js 15 params are Promises
// Already handled in current codebase: await params
// No changes needed for this

// GOTCHA: Contentlayer generates .contentlayer folder
// MUST add to .gitignore
// Contains auto-generated types and data

// PATTERN: Contentlayer MDX configuration
// Use mdx.remarkPlugins and mdx.rehypePlugins arrays
// Pass plugins as [plugin, options] for configuration
// Example:
mdx: {
  remarkPlugins: [
    remarkGfm,                              // No options
    [remarkPlantUML, { baseUrl: '...' }],  // With options
  ],
  rehypePlugins: [
    rehypeHeadingIds,
    rehypeImagePath,
  ],
}

// CRITICAL: Image path transformation timing
// Current: lib/markdown.ts transformImagePaths() runs AFTER remark processing
// New: Must be rehype plugin (operates on HTML/HAST)
// Pattern: Match <img> tags and replace src="/public/images/" → "/images/"

// CRITICAL: Heading ID generation timing
// Current: lib/markdown.ts addHeadingIds() runs AFTER remark processing
// New: Must be rehype plugin (operates on HTML/HAST)
// Pattern: Add id attributes to <h2> and <h3> elements
// Alternative: Use existing rehype-slug plugin (recommended)

// PATTERN: Accessing generated types
// Import from '@contentlayer/generated'
import { allPosts, Post } from '@contentlayer/generated'
// Type safety: Post type auto-generated from contentlayer.config.ts schema

// GOTCHA: Date handling
// Contentlayer can auto-parse dates with type: 'date'
// Our current format: "2025-10-15" (ISO string)
// Will be parsed to Date object automatically

// PATTERN: Frontmatter defaults
// Use 'required: false' and 'default: value' in schema
// Example: featured: { type: 'boolean', default: false }
```

---

## Implementation Blueprint

### Data Models and Structure

```typescript
// contentlayer.config.ts
// Defines content schema matching current types/post.ts structure

import { defineDocumentType, makeSource } from 'contentlayer2/source-files'
import remarkGfm from 'remark-gfm'
import remarkPlantUML from './lib/remark-plantuml'
import rehypeSlug from 'rehype-slug' // For heading IDs
import rehypeImagePath from './lib/rehype-image-path' // Custom plugin

export const Post = defineDocumentType(() => ({
  name: 'Post',
  filePathPattern: `**/*.md`,
  contentType: 'markdown', // NOT mdx, we use markdown
  fields: {
    title: {
      type: 'string',
      required: true,
    },
    excerpt: {
      type: 'string',
      required: true,
    },
    date: {
      type: 'date', // Auto-parses ISO date strings
      required: true,
    },
    tags: {
      type: 'list',
      of: { type: 'string' },
      required: true,
    },
    author: {
      type: 'nested',
      of: {
        name: { type: 'string', required: true },
        avatar: { type: 'string', required: false },
      },
    },
    featured: {
      type: 'boolean',
      default: false,
    },
    views: {
      type: 'number',
      required: false,
    },
  },
  computedFields: {
    slug: {
      type: 'string',
      resolve: (post) => post._raw.sourceFileName.replace(/\.md$/, ''),
    },
    readTime: {
      type: 'number',
      resolve: (post) => {
        const wordCount = post.body.raw.split(/\s+/).length
        return Math.ceil(wordCount / 200)
      },
    },
  },
}))

export default makeSource({
  contentDirPath: 'content/posts',
  documentTypes: [Post],
  markdown: {
    remarkPlugins: [
      remarkGfm,           // GitHub Flavored Markdown
      remarkPlantUML,      // Custom PlantUML plugin
    ],
    rehypePlugins: [
      rehypeSlug,          // Add IDs to headings (h1-h6)
      rehypeImagePath,     // Transform /public/images/ → /images/
    ],
  },
})
```

---

### List of Tasks (In Order)

```yaml
Task 1: Install Dependencies
COMMAND: npm install contentlayer2 next-contentlayer2 remark-gfm rehype-slug
VERIFY: package.json updated with new dependencies
CRITICAL: Use contentlayer2 (NOT contentlayer) for Next.js 15 compatibility

Task 2: Create Contentlayer Configuration
CREATE: contentlayer.config.ts
  - COPY schema from types/post.ts
  - ADD computedFields for slug and readTime
  - CONFIGURE remarkPlugins: [remarkGfm, remarkPlantUML]
  - CONFIGURE rehypePlugins: [rehypeSlug, rehypeImagePath]
  - SET contentDirPath: 'content/posts'

Task 3: Create Custom Rehype Plugin for Image Path Transformation
CREATE: lib/rehype-image-path.ts
  - MIRROR pattern from lib/markdown.ts transformImagePaths()
  - OPERATE on HAST (HTML AST) nodes
  - FIND: <img> nodes with src="/public/images/..."
  - TRANSFORM: src="/images/..."
  - PRESERVE: All other attributes

Task 4: Update Next.js Configuration
MODIFY: next.config.js
  - IMPORT: { withContentlayer } from 'next-contentlayer2'
  - WRAP: existing config with withContentlayer()
  - PATTERN:
    ```javascript
    import { withContentlayer } from 'next-contentlayer2'

    const nextConfig = {
      // existing config
    }

    export default withContentlayer(nextConfig)
    ```

Task 5: Update TypeScript Configuration
MODIFY: tsconfig.json
  - ADD to compilerOptions.paths:
    ```json
    {
      "paths": {
        "@contentlayer/generated": ["./.contentlayer/generated"],
        "@contentlayer/generated/*": ["./.contentlayer/generated/*"]
      }
    }
    ```
  - ADD to include: [".contentlayer/generated"]

Task 6: Update .gitignore
MODIFY: .gitignore
  - ADD: .contentlayer/
  - REASON: Generated files should not be committed

Task 7: Refactor lib/posts.ts
MODIFY: lib/posts.ts
  - REMOVE: import { parseMarkdown } from './markdown'
  - REMOVE: fs.readFileSync and manual file reading
  - ADD: import { allPosts, type Post } from '@contentlayer/generated'
  - MODIFY getAllPosts():
    ```typescript
    export function getAllPosts(): Post[] {
      return allPosts
    }
    ```
  - MODIFY getPostBySlug():
    ```typescript
    export function getPostBySlug(slug: string): Post | undefined {
      return allPosts.find((post) => post.slug === slug)
    }
    ```
  - MODIFY getSortedPosts():
    ```typescript
    export function getSortedPosts(): Post[] {
      return allPosts.sort((a, b) =>
        new Date(b.date).getTime() - new Date(a.date).getTime()
      )
    }
    ```
  - PRESERVE: getAllTags() and getRecommendedPosts() logic (unchanged)
  - REMOVE: async from all functions (Contentlayer data is sync)

Task 8: Delete Obsolete Files
DELETE: lib/markdown.ts
  - REASON: Functionality now handled by Contentlayer + plugins
PRESERVE: lib/remark-plantuml.ts
  - REASON: Still needed as remark plugin

Task 9: Update Page Components
MODIFY: app/page.tsx
  - REMOVE: async from function signatures
  - REMOVE: await from getAllTags(), getSortedPosts() calls
  - TYPE: Posts are now typed as Post from '@contentlayer/generated'

MODIFY: app/posts/[slug]/page.tsx
  - REMOVE: async from function signatures (except generateMetadata, generateStaticParams)
  - REMOVE: await from getPostBySlug() call
  - UPDATE: post.content now contains HTML (use dangerouslySetInnerHTML as before)
  - UPDATE: post.date is now Date object (format with date-fns as before)
  - HANDLE: Not found case (post === undefined instead of null)

MODIFY: Other pages using posts (tags, etc.)
  - REMOVE: async/await where applicable
  - UPDATE: Type imports

Task 10: Verification & Testing
RUN: npm run dev
  - VERIFY: Build succeeds with Contentlayer generation
  - CHECK: Console for "Generated X documents" message
  - VERIFY: .contentlayer folder created

TEST: Homepage
  - VERIFY: All posts displayed
  - VERIFY: Tags work
  - VERIFY: Search works

TEST: Individual Post Page
  - VERIFY: Post renders correctly
  - VERIFY: PlantUML diagrams render (if any)
  - VERIFY: Images display correctly (path transformation worked)
  - VERIFY: TOC works (headings have IDs)
  - VERIFY: GFM features work (tables, strikethrough if any)

TEST: Type Safety
  - RUN: npx tsc --noEmit
  - VERIFY: No type errors

TEST: Production Build
  - RUN: npm run build
  - VERIFY: Build succeeds
  - VERIFY: All pages pre-rendered
```

---

### Per-Task Pseudocode

#### Task 3: Custom Rehype Plugin (rehype-image-path.ts)

```typescript
// lib/rehype-image-path.ts
import { visit } from 'unist-util-visit'
import type { Plugin } from 'unified'
import type { Root, Element } from 'hast'

/**
 * Rehype plugin to transform image paths from /public/images/ to /images/
 *
 * CRITICAL: Operates on HAST (HTML AST), not MDAST
 * PATTERN: Similar to lib/markdown.ts transformImagePaths() but for AST
 */
const rehypeImagePath: Plugin<[], Root> = () => {
  return (tree) => {
    visit(tree, 'element', (node: Element) => {
      // FIND: <img> elements with src starting with /public/images/
      if (node.tagName === 'img' && node.properties?.src) {
        const src = node.properties.src as string
        if (src.startsWith('/public/images/')) {
          // TRANSFORM: Replace /public/images/ with /images/
          node.properties.src = src.replace('/public/images/', '/images/')
        }
      }
    })
  }
}

export default rehypeImagePath
```

#### Task 7: Refactor lib/posts.ts

```typescript
// lib/posts.ts (AFTER refactor)

import { allPosts, type Post } from '@contentlayer/generated'

// CRITICAL: No more async - Contentlayer data is synchronous
export function getAllPosts(): Post[] {
  return allPosts
}

export function getPostBySlug(slug: string): Post | undefined {
  return allPosts.find((post) => post.slug === slug)
}

export function getSortedPosts(): Post[] {
  return allPosts.sort((a, b) =>
    new Date(b.date).getTime() - new Date(a.date).getTime()
  )
}

// PRESERVE: These functions unchanged
export function getAllTags(): string[] {
  const posts = getAllPosts()
  const tags = posts.flatMap((post) => post.tags)
  return Array.from(new Set(tags)).sort()
}

export function getRecommendedPosts(allPosts: Post[]): Post[] {
  if (allPosts.length <= 3) {
    return allPosts
  }
  const recommendedPosts = allPosts.filter((post) => post.featured).slice(0, 3)
  const finalRecommendedPosts =
    recommendedPosts.length >= 3
      ? recommendedPosts
      : [...recommendedPosts, ...allPosts.slice(0, 3 - recommendedPosts.length)]
  return finalRecommendedPosts
}
```

---

## Integration Points

```yaml
NEXT.JS CONFIG:
  - modify: next.config.js
  - action: Wrap config with withContentlayer()
  - pattern: import { withContentlayer } from 'next-contentlayer2'

TYPESCRIPT CONFIG:
  - modify: tsconfig.json
  - action: Add path mappings for @contentlayer/generated
  - pattern: Add ".contentlayer/generated" to paths and include

CONTENT GENERATION:
  - trigger: On file save in content/posts/*.md
  - action: Contentlayer auto-regenerates types and data
  - result: Hot-reload in development

BUILD PROCESS:
  - phase: Before Next.js build
  - action: Contentlayer generates all content
  - output: .contentlayer/generated with types and JSON data
```

---

## Validation Loop

### Level 1: Syntax & Type Checking

```bash
# FIRST: Test Contentlayer generation
npx contentlayer2 build
# Expected: "Generated X documents" with no errors
# If errors: Check contentlayer.config.ts schema and frontmatter validity

# Type checking
npx tsc --noEmit
# Expected: No errors
# If errors: Check @contentlayer/generated imports and type usage
```

### Level 2: Development Server

```bash
# Start dev server
npm run dev

# Expected:
# - "Generated X documents" message
# - Server starts on http://localhost:3000
# - No runtime errors

# Manual testing:
# 1. Visit http://localhost:3000 - homepage loads
# 2. Visit http://localhost:3000/posts/hello-world - post page loads
# 3. Check PlantUML diagrams render (if present)
# 4. Check images display correctly
# 5. Check TOC links work (click heading link, page scrolls)
# 6. Edit a markdown file, verify hot-reload works
```

### Level 3: Production Build

```bash
# Build for production
npm run build

# Expected:
# - Contentlayer generation succeeds
# - Next.js build succeeds
# - All pages pre-rendered (Static)
# - No warnings or errors

# If build fails:
# - Check console for Contentlayer errors
# - Verify all markdown files have valid frontmatter
# - Check plugin compatibility
```

### Level 4: Runtime Verification

```bash
# Start production server
npm run start

# Test all pages:
# 1. Homepage: Articles list, tags, recommended posts
# 2. Individual posts: Content, images, PlantUML, TOC
# 3. Tags pages: Tag filtering works
# 4. About/Contact: Still functional

# Verify features:
# - PlantUML diagrams render correctly
# - Images paths are correct (/images/ not /public/images/)
# - TOC links work (headings have IDs)
# - GFM features work (tables, strikethrough)
# - Metadata correct (SEO, Open Graph)
```

---

## Final Validation Checklist

- [ ] Contentlayer2 + next-contentlayer2 installed correctly
- [ ] contentlayer.config.ts created with correct schema
- [ ] All remark/rehype plugins configured
- [ ] next.config.js wrapped with withContentlayer
- [ ] tsconfig.json includes .contentlayer paths
- [ ] .gitignore excludes .contentlayer/
- [ ] lib/posts.ts refactored (no async, uses allPosts)
- [ ] lib/markdown.ts deleted
- [ ] lib/rehype-image-path.ts created and working
- [ ] All pages updated (removed async/await where needed)
- [ ] Type checking passes: `npx tsc --noEmit`
- [ ] Dev server runs: `npm run dev`
- [ ] Content hot-reloads when editing markdown
- [ ] Production build succeeds: `npm run build`
- [ ] All posts display correctly
- [ ] PlantUML diagrams render
- [ ] Images display (paths transformed)
- [ ] TOC works (headings have IDs)
- [ ] GFM features work (tables, strikethrough)
- [ ] SEO metadata correct
- [ ] No console errors or warnings

---

## Anti-Patterns to Avoid

- ❌ Don't use original `contentlayer` package (not compatible with Next.js 15)
- ❌ Don't keep lib/markdown.ts after migration (creates confusion)
- ❌ Don't forget to update .gitignore (.contentlayer folder is large)
- ❌ Don't use async functions in lib/posts.ts (Contentlayer data is sync)
- ❌ Don't manually read files from content/posts (defeats Contentlayer purpose)
- ❌ Don't skip rehype plugins (needed for image paths and heading IDs)
- ❌ Don't assume Contentlayer auto-handles custom transformations (must use plugins)
- ❌ Don't forget to preserve PlantUML plugin (critical feature)
- ❌ Don't change frontmatter structure without updating contentlayer.config.ts
- ❌ Don't commit .contentlayer folder to git (large and auto-generated)

---

## Known Risks & Mitigation

### Risk 1: Plugin Compatibility Issues
**Problem**: remark-gfm or custom plugins may not work with Contentlayer
**Mitigation**:
- Test each plugin individually
- Fallback: Keep current manual parsing for problematic plugins
- Alternative: Fork and adapt plugins if needed

### Risk 2: Image Path Transformation Fails
**Problem**: Rehype plugin doesn't catch all image references
**Mitigation**:
- Thoroughly test with various image formats
- Add comprehensive logging to plugin
- Fallback: Post-process HTML if needed

### Risk 3: Type Generation Issues
**Problem**: Generated types don't match expected structure
**Mitigation**:
- Carefully mirror types/post.ts in contentlayer.config.ts
- Test type inference with real data
- Add manual type assertions if needed

### Risk 4: Build Performance
**Problem**: Contentlayer generation slows build
**Mitigation**:
- Acceptable for small blogs (<1000 posts)
- Monitor build times
- Consider incremental builds if needed

---

## Reference Links

- Contentlayer2 NPM: https://www.npmjs.com/package/contentlayer2
- Contentlayer Docs: https://contentlayer.dev/docs/getting-started-cddd76b7
- remark-gfm: https://github.com/remarkjs/remark-gfm
- rehype-slug: https://github.com/rehypejs/rehype-slug
- Next.js 15 Docs: https://nextjs.org/docs

---

## Success Metrics

- **Zero Regression**: All existing features work identically
- **Type Safety**: 100% type coverage for Post objects
- **Performance**: Build time <2x current (acceptable tradeoff)
- **Developer Experience**: Hot-reload works for content changes
- **Maintainability**: Less code, clearer separation of concerns

---

**Confidence Level: 8/10**

**Reasoning**:
- ✅ Clear migration path documented
- ✅ All current features can be replicated
- ✅ Contentlayer2 proven to work with Next.js 15
- ⚠️ Plugin compatibility needs testing (minor risk)
- ⚠️ Custom rehype plugin needs implementation (straightforward)

**Estimated Time**: 2-3 hours for experienced developer with testing
